# アダプターおよび主要コンポーネント拡充ロードマップ

## 1. はじめに

本ドキュメントは、バッチフレームワークの機能拡張に関するロードマップを定義します。特に、外部システムとの連携を担うアダプター層の拡充と、それに伴うフレームワークの主要コンポーネントの強化に焦点を当てます。これにより、フレームワークの柔軟性、拡張性、および多様なユースケースへの対応能力を向上させることを目指します。

## 2. 現在の状況

*   **データベースアダプター:**
    *   リレーショナルデータベース（PostgreSQL, MySQL, SQLite）向けのGORMベースのアダプターが存在します。
    *   InMemoryリポジトリ使用時に、ダミーDBアダプターが自動的に提供される構成です。
    *   データベースマイグレーション処理におけるDBドライバの登録が整理され、一元化されています。
*   **主要コンポーネント:**
    *   ジョブ、ステップ、タスクレット、アイテム処理（リーダー/プロセッサー/ライター）、リスナー、決定、分割などの基本的なバッチ処理コンポーネントが実装されています。
    *   ロギング、メトリクス、トレーシングなどの横断的機能が提供されています。

## 3. アダプター拡充ロードマップ

外部システムとの連携を強化するため、以下の新しいアダプターの実装を計画します。

### 3.1. BigQuery (BQ) アダプター

*   **目的:** Google BigQueryとのデータ連携を可能にする。
*   **パス:** `pkg/batch/adaptor/bigquery/gorm/`
*   **内容:**
    *   BigQuery用のGORMライブラリを利用したアダプターを実装します。
    *   既存の `adaptor.DBConnection`、`adaptor.DBProvider`、`tx.TransactionManager` などのインターフェースをBigQuery向けに実装します。
    *   BigQuery特有の認証（サービスアカウントなど）や接続設定をサポートします。

### 3.2. ストレージアダプター

*   **目的:** S3やGCSなどのオブジェクトストレージとのファイル連携（JSON, Parquetなどのアップロード/ダウンロード）を可能にする。
*   **パス:**
    *   S3: `pkg/batch/adaptor/storage/s3/`
    *   GCS: `pkg/batch/adaptor/storage/gcs/`
*   **共通インターフェースパス:** `pkg/batch/core/adaptor/storage.go`
*   **個別アダプターパス:**
    *   S3: `pkg/batch/adaptor/storage/s3/` (例: `s3_adapter.go`)
    *   GCS: `pkg/batch/adaptor/storage/gcs/` (例: `gcs_adapter.go`)
*   **内容:**
    *   `pkg/batch/core/adaptor/storage.go` に、`ObjectStorageAdapter` という汎用的なオブジェクトストレージ操作インターフェースを定義します。
    *   S3およびGCSそれぞれに対応するアダプター（例: `gcsAdapter`）は、この `ObjectStorageAdapter` インターフェースを実装します。
    *   ファイル（JSON, Parquetなど）のアップロード、ダウンロード、リスト、削除などの基本操作をサポートします。
    *   **設定:** `pkg/batch/core/config/config.go` に、`Datasources` と同様に、名前付きのオブジェクトストレージ接続設定（例: `StorageConnections map[string]StorageConfig`）を追加することを検討します。これにより、複数のストレージ接続を一元的に管理し、名前で解決できるようになります。

### 3.3. Redshift アダプター

*   **目的:** Amazon Redshiftとの連携を最適化する。
*   **パス:** `pkg/batch/adaptor/redshift/gorm/`
*   **内容:**
    *   GORMとAWS SDK for Goの両方を組み合わせたアダプターを実装します。
    *   GORMを用いて基本的なCRUD操作をカバーし、AWS SDKを用いてRedshift固有の機能（例: S3からの`COPY`/`UNLOAD`コマンド、クラスタ管理操作など）をサポートします。

### 3.4. SQLビルダーアダプター

*   **目的:** 複雑な動的SQLクエリの構築を支援し、データベース非依存のクエリ生成を可能にする。
*   **パス:** `pkg/batch/adaptor/database/sqlbuilder/`
*   **内容:**
    *   SQLクエリをプログラム的に構築するための機能を提供します。
    *   これにより、生SQLの記述を減らし、SQLインジェクションのリスクを低減しながら、動的なクエリを安全かつ読みやすく生成できるようにします。

### 3.5. Ent (ORM) アダプター

*   **目的:** Entフレームワークを利用したORM機能を提供する。
*   **パス:** `pkg/batch/adaptor/database/ent/`
*   **内容:**
    *   Entフレームワークを利用したORMアダプターを実装します。
    *   既存の `adaptor.DBConnection` や `adaptor.DBProvider` インターフェースをEntベースで実装し、フレームワーク全体の一貫性を保ちます。

### 3.6. セキュリティプロキシアダプター

*   **目的:** ネットワーク通信におけるセキュリティ機能（フィルタリング、モックなど）を提供する。
*   **パス:**
    *   DNS関連: `pkg/batch/adaptor/security/dns/`
    *   HTTPプロキシ関連: `pkg/batch/adaptor/security/proxy/http/`
*   **内容:**
    *   **DNS:** キャッシュ、フィルタリング、特定のドメインをモック用のサービスURLに解決する機能（例: localhostへのモック）を実装します。
    *   **HTTPプロキシ:** SWG (Secure Web Gateway) や CASB (Cloud Access Security Broker) に類似するセキュリティ機能（コンテンツフィルタリング、DLP、アクセス制御、脅威防御など）と、特定のURLへのリクエストをモック応答に置き換える機能を実装します。
    *   両アダプターにおいて、Prometheusによるメトリクス計測とOpenTelemetryによるトレースをサポートし、処理の分析を可能にします。

## 4. 主要コンポーネント拡充の必要性

アダプターの拡充に伴い、フレームワークの他の主要コンポーネントも強化し、より多様なバッチ処理の要件に対応できるようにします。

*   **タスクレット:**
    *   新しい種類のタスクレット（例: 高度なデータ変換、外部API連携、ファイル操作、シェルコマンド実行など）を追加し、汎用的な処理能力を向上させます。
*   **アイテムリーダー/プロセッサー/ライター:**
    *   新しいデータソース/シンク（例: Kafka、RabbitMQなどのメッセージキュー、ストリーミングデータプラットフォーム）に対応するアイテムコンポーネントを追加し、データ連携の幅を広げます。
*   **リスナー:**
    *   ジョブやステップの実行ライフサイクルにおける、より詳細なイベント（例: 外部システム連携イベント、リソース使用状況イベントなど）に対応するリスナーを追加します。
*   **決定 (Decision) / 分割 (Split):**
    *   より高度なフロー制御ロジック（例: 複雑な条件分岐、動的な並列処理の制御）をサポートする決定および分割コンポーネントを開発します。
*   **エラーハンドリング/リトライ/スキップ:**
    *   より柔軟なエラー処理ポリシー（例: 特定のエラータイプに対するカスタムリトライ戦略、スキップ条件の細分化）を定義できる機能を追加します。
*   **モニタリング/ロギング:**
    *   統合されたダッシュボード機能、アラート機能、ログ集約システムとの連携を強化し、運用時の可視性と管理性を向上させます。
*   **スケジューリング/オーケストレーション:**
    *   外部スケジューラ（例: Kubernetes CronJob, Airflow）との連携を容易にするためのインターフェースやアダプターを検討し、ジョブの実行管理を外部システムに委ねることを可能にします。
*   **CLI/UI:**
    *   ジョブの実行状況の確認、パラメータの変更、再実行などの管理操作を容易にするためのコマンドラインインターフェース（CLI）や基本的なユーザーインターフェース（UI）の提供を検討します。

## 5. 全体的な方針

*   **モジュール性:** 各アダプターおよびコンポーネントは独立したモジュールとして設計し、疎結合を維持します。
*   **拡張性:** ユーザーが独自のアダプターやコンポーネントを容易に作成し、フレームワークに組み込めるような設計を重視します。
*   **テスト容易性:** 各コンポーネントは単体テストおよび統合テストが容易に行えるように設計します。
*   **パフォーマンス:** 大規模なデータ処理に対応できるよう、パフォーマンスと効率性を考慮した実装を行います。

## 6. 今後の進め方

本ロードマップに記載された各項目について、詳細な設計、優先順位付け、および具体的な実装計画を策定し、順次開発を進めていきます。
