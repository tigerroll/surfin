id: weatherJob # Match config.Batch.JobName
name: Weather Data Processing Job
description: This job fetches weather data, processes it, and stores it.
incrementer: # Add
  ref: "timestampIncrementer" # Add: Generates unique parameters using a timestamp every time
listeners:
  - ref: loggingJobListener # Listener name registered in JobFactory
  - ref: jobCompletionSignaler

flow:
  start-element: migrateMetadataStep # Starting element of the flow
  elements:
    migrateMetadataStep: # Step to run framework migrations
      id: migrateMetadataStep
      tasklet:
        ref: migrationTasklet
        properties:
          dbRef: "metadata" # DB connection name used by JobRepository
          migrationFSName: "frameworkMigrationsFS" # Framework migration FS name
          migrationDir: "postgres" # Directory containing PostgreSQL migration files
          isFramework: "true" # Indicates this is a framework migration
      listeners:
        - ref: loggingStepListener
      transitions:
        - on: COMPLETED
          to: migrateWorkloadStep # Transition to next step on success
        - on: FAILED
          fail: true
          
    migrateWorkloadStep: # Step to run application migrations for workload DB
      id: migrateWorkloadStep
      tasklet:
        ref: migrationTasklet
        properties:
          dbRef: "workload" # Workload DB connection name
          migrationFSName: "weatherAppFS" # Application migration FS name
          migrationDir: "postgres" # Directory containing SQLite migration files
          isFramework: "false" # Indicates this is an application migration
      listeners:
        - ref: loggingStepListener
      transitions:
        - on: COMPLETED
          to: fetchWeatherDataStep # Transition to data processing step on success
        - on: FAILED
          fail: true

    fetchWeatherDataStep:
      id: fetchWeatherDataStep
      reader:
        ref: weatherItemReader
      processor:
        ref: weatherItemProcessor
      writer: # Write to database
        ref: weatherItemWriter
        properties:
          targetDBName: "workload" # Specify target DB name for Writer
      chunk:
        item-count: 50 # Use config.Batch.ChunkSize
        commit-interval: 1
      listeners: # Step level listeners
        - ref: loggingStepListener
      item-read-listeners: # Enable item read listeners
        - ref: loggingItemReadListener
      item-process-listeners: # Enable item process listeners
        - ref: loggingItemProcessListener
      item-write-listeners: # Enable item write listeners
        - ref: loggingItemWriteListener
      skip-listeners: # Item skip listeners
        - ref: loggingSkipListener
      retry-item-listeners: # Item retry listeners
        - ref: loggingRetryItemListener
      chunk-listeners:
        - ref: loggingChunkListener
      execution-context-promotion: # Promote reader state to Job EC
        keys:
          - "reader_context" # Promote the entire context saved by WeatherReader
          - "decision.condition" # Promote the condition set by the tasklet
      transitions:
        - on: COMPLETED # If the step completes successfully
          to: checkConditionDecision # Transition directly to Decision
        - on: FAILED # If the step fails
          fail: true # Terminate the entire job as failed
          
    checkConditionDecision: # ConditionalDecision element
      id: checkConditionDecision
      ref: conditionalDecision # Reference to Decision Builder
      properties:
        conditionKey: "decision.condition" # Key to retrieve from ExecutionContext
        expectedValue: "true"             # COMPLETED if it matches this value
        defaultStatus: "FAILED"           # Default status if no match or key not found
      transitions:
        - on: COMPLETED # If decision.condition is "true"
          to: randomFailTaskletStep # To the existing randomFailTaskletStep
        - on: FAILED # If decision.condition is not "true", or key not found
          to: anotherRandomFailTaskletStep # To another path
          
    randomFailTaskletStep:
      id: randomFailTaskletStep
      tasklet:
        ref: randomFailTasklet # ref name
        properties:
          message: "Condition was TRUE! Executing randomFailTaskletStep."
      listeners: # Step level listeners
        - ref: loggingStepListener
      transitions:
        - on: COMPLETED
          end: true
        - on: FAILED
          fail: true
          
    anotherRandomFailTaskletStep:
      id: anotherRandomFailTaskletStep
      tasklet:
        ref: randomFailTasklet # ref name
        properties:
          message: "Condition was FALSE or not found! Executing anotherRandomFailTaskletStep."
      listeners:
        - ref: loggingStepListener
      transitions:
        - on: COMPLETED
          end: true
        - on: FAILED
          fail: true
  transition-rules: # Transition rules are defined within elements for clarity
